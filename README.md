# Containerized `bitcoind`

This repo builds [`bitcoind`] and packages it into a minimal Docker containers
provided for various CPU architectures.

> [!NOTE]
> The work here was initially based on
[lncm/docker-bitcoind](https://github.com/lncm/docker-bitcoind), but has
significantly diverged since.

## Usage

### Pull

First pull the image from [Docker Hub]:

```bash
docker pull frankhinek/bitcoind:v28.0
```

> [!NOTE] 
> Running above will automatically choose native architecture of your CPU.

Or, to pull a specific CPU architecture:

```bash
docker pull frankhinek/bitcoind:v28.0-arm64v8
``` 

### Start

First, create a directory on your host system which will store the [`bitcoind`]
configuration file and bitcoin chain data. For example, to use a directory
named `bitcoin/` in the current working directory:

```sh
mkdir bitcoin/
```

Next, create a config file:

```sh
touch bitcoin/bitcoin.conf
```

You can take a look at the following sample: thebox-compose-system ([1](https://github.com/lncm/thebox-compose-system/blob/master/bitcoin/bitcoin.conf)).

Some guides on how to configure bitcoin can be found [here](https://github.com/bitcoin/bitcoin/blob/master/doc/bitcoin-conf.md) (bitcoin git repo)

Then to start [`bitcoind`], run:

```bash
docker run  -it  --rm  --detach \
    -v ./bitcoin:/data/.bitcoin \
    -p 8332:8332 \
    -p 8333:8333 \
    --name bitcoind \
    frankhinek/bitcoind:v28.1
```

That will run bitcoind such that:

* all data generated by the container is stored in `bitcoin/` **on your host machine**,
* port `8332` will be reachable for the RPC communication,
* port `8333` will be reachable for the peer-to-peer communication,
* created container will get named `bitcoind`,
* within the container, `bitcoind` binary is run as unprivileged user `bitcoind` (`UID=1000`),
* that command will run the container in the background and print the ID of the container being run.

#### Interact

To issue any commands to a running container, do:

```bash
docker exec -it bitcoind BINARY COMMAND
```

Where:
* `BINARY` is either `bitcoind` or `bitcoin-cli` and
* `COMMAND` is something you'd normally pass to the binary   

Examples:

```bash
docker exec -it bitcoind bitcoind --help
docker exec -it bitcoind bitcoind --version
docker exec -it bitcoind bitcoin-cli --help
docker exec -it bitcoind bitcoin-cli -getinfo
docker exec -it bitcoind bitcoin-cli getblockcount
```

#### Fast Sync with AssumeUTXO

Bitcoin Core v28 introduced AssumeUTXO, allowing nodes to sync from a recent
UTXO set snapshot instead of starting from genesis. This enables nodes to become
operational within minutes while historical blocks are verified in the
background, maintaining the same security guarantees as a node that doesnâ€™t use
AssumeUTXO.

1. Download a UTXO Snapshot file (9.77 GB) to your `bitcoin/` directory:

   ```sh
   wget --show-progress --no-clobber -P bitcoin/ https://lopp.net/download/utxo-snapshot-height-840000.dat
   ```

1. Run Bitcoin Core.

1. Wait for the block headers to finish syncing (should take 2 to 3 minutes).

    ```sh
    bitcoind  | 2025-02-13T20:58:22Z Pre-synchronizing blockheaders, height: 2000 (~0.24%)
    bitcoind  | 2025-02-13T20:58:23Z Pre-synchronizing blockheaders, height: 4000 (~0.47%)
    ...
    bitcoind  | 2025-02-13T21:00:40Z Synchronizing blockheaders, height: 1379 (~0.16%)
    bitcoind  | 2025-02-13T21:00:40Z Synchronizing blockheaders, height: 3379 (~0.40%)
    ...
    bitcoind  | 2025-02-13T21:02:15Z Synchronizing blockheaders, height: 882000 (~99.82%)
    bitcoind  | 2025-02-13T21:02:15Z Synchronizing blockheaders, height: 883631 (~100.00%)
    ```

1. Load the UTXO snapshot:
    ```sh
    docker exec -it bitcoind bitcoin-cli -rpcclienttimeout=0 loadtxoutset /data/.bitcoin/utxo-snapshot-height-840000.dat
    ```

1. Wait for the UTXO snapshot loading process to finish (this will take 20 to 30
   minutes depending upon the speed of your machine).

Once the command finishes, your node's sync progress will jump forward to the
block height of the snapshot (840000) and continue syncing normally from there.

After it reaches chain tip, the node will start performing a sync from genesis
in the background, but the node will be usable.

### Docker Compose

For easier container management, you can use [Docker Compose].

Prerequisites:

- Create a `bitcoin/` directory in the same location as your `docker-compose.yml`
- Place your `bitcoin.conf` file in the `bitcoin/` directory

Create a `docker-compose.yml` with the following configuration for mainnet:

```yaml
services:
  bitcoin:
    image: frankhinek/bitcoind:v28.1
    container_name: bitcoind
    user: 1000:1000
    volumes:
      - ./bitcoin:/data/.bitcoin
    restart: on-failure
    stop_grace_period: 15m30s
    ports:
      - "8333:8333"  # P2P port
      - "8332:8332"  # RPC port
```

The configuration above:

- Mounts local `bitcoin/` directory to `/data/.bitcoin`
- Maps standard Bitcoin ports (8333 for P2P, 8332 for RPC)
- Restarts the container on failure
- Allows 15.5 minutes for clean shutdown
- Runs as non-root user (UID 1000)

Common commands:

```sh
# Start the node in the background
docker compose up -d

# View container logs
docker compose logs -f

# Stop the node
docker compose down

# Check node status
docker compose ps
```

## Building the Image

To build the Bitcoin Core Docker image locally:

```sh
cd v28.1/

# Build for your current architecture
docker buildx build -t frankhinek/bitcoind:v28.1 .

# Build for a specific platform (e.g., ARM64)
docker buildx build --platform linux/arm64 -t frankhinek/bitcoind:v28.1 .

# Build for multiple platforms
docker buildx build --platform linux/amd64,linux/arm64 -t frankhinek/bitcoind:v28.1 .
```

To push to Docker Hub:

```sh
# Login to Docker Hub
docker login

# Push the image
docker push frankhinek/bitcoind:v28.1
```

[`bitcoind`]: https://github.com/bitcoin/bitcoin
[Docker Compose]: https://docs.docker.com/compose/
[Docker Hub]: https://hub.docker.com/r/frankhinek/bitcoind